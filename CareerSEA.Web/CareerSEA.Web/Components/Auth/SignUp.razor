@page "/signup"
@using System.ComponentModel.DataAnnotations
@using MudBlazor

@* FIX: Commented out ApiClient to prevent crash if the service isn't registered yet *@
@* @inject ApiClient apiClient *@ 
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@* FIX: Removed @rendermode InteractiveServer (Handled globally in App.razor) *@
@* FIX: Removed MudProviders (Handled in MainLayout.razor) *@

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="d-flex align-center justify-center" Style="min-height: 100vh; background-image: linear-gradient(to bottom right, #f0fdfa, #ffffff, #f0fdfa); padding: 0.5rem;">

    <MudCard Elevation="20" Class="w-100" Style="max-width: 28rem;">

        <MudCardHeader Class="pa-6">
            <CardHeaderContent>
                <MudText Typo="Typo.h5" Align="Align.Center" Class="font-weight-bold">Create an Account</MudText>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="mud-text-secondary">
                    Enter your details below to get started
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent Class="pa-6 pt-0">
            <EditForm Model="@model" OnValidSubmit="HandleValidSubmit" FormName="SignUpForm">
                <DataAnnotationsValidator />

                <MudGrid Spacing="2">

                    <MudItem xs="6">
                        <MudTextField Label="First Name"
                                      Variant="Variant.Outlined"
                                      @bind-Value="model.FirstName"
                                      For="@(() => model.FirstName)"
                                      Required="true" />
                    </MudItem>

                    <MudItem xs="6">
                        <MudTextField Label="Last Name"
                                      Variant="Variant.Outlined"
                                      @bind-Value="model.LastName"
                                      For="@(() => model.LastName)"
                                      Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Username"
                                      Placeholder="Your Username or Email"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      @bind-Value="model.Username"
                                      For="@(() => model.Username)"
                                      Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      @bind-Value="model.Password"
                                      For="@(() => model.Password)"
                                      Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Confirm Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      @bind-Value="model.ConfirmPassword"
                                      For="@(() => model.ConfirmPassword)"
                                      Required="true" />
                    </MudItem>

                    <MudItem xs="12" Class="mt-4">
                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   Size="Size.Large">
                            Create Account
                        </MudButton>
                    </MudItem>

                </MudGrid>
            </EditForm>
        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pa-6 pt-2">
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                Already have an account?
                <MudLink Href="/" Typo="Typo.body2">Sign In</MudLink>
            </MudText>
        </MudCardActions>

    </MudCard>
</MudContainer>

@code {
    [SupplyParameterFromForm(FormName = "SignUpForm")]
    public RegisterDTO model { get; set; } = new();

    public class RegisterDTO
    {
        [Required(ErrorMessage = "First name is required")]
        public string FirstName { get; set; }

        [Required(ErrorMessage = "Last name is required")]
        public string LastName { get; set; }

        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; }

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; }

        [Required(ErrorMessage = "Please confirm your password")]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; }
    }

    private async Task HandleValidSubmit()
    {
        // TEMPORARY: Simulate a success so you can see the visual effect
        await Task.Delay(500);
        Snackbar.Add("Visual Test: Sign up submitted!", Severity.Success);

        // Uncomment the lines below when you are ready to connect the API
        /*
        var result = await apiClient.PostAsJsonAsync<RegisterDTO, BaseResponseModel>("/api/Auth/Register", model);

        if (result != null && result.Success)
        {
            Snackbar.Add("Account created successfully! Please log in.", Severity.Success);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add("Error", Severity.Error);
        }
        */
    }
}