@page "/signup"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using CareerSEA.Contracts.Requests
@using CareerSEA.Contracts.Responses
@inject ApiClient apiClient

@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Sign Up</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="d-flex align-center justify-center" Style="min-height: 100vh; background-image: linear-gradient(to bottom right, #f0fdfa, #ffffff, #f0fdfa); padding: 0.5rem;">

    <MudCard Elevation="20" Class="w-100" Style="max-width: 28rem;">

        <MudCardHeader Class="pa-6">
            <CardHeaderContent>
                <MudText Typo="Typo.h5" Align="Align.Center" Class="font-weight-bold">Create an Account</MudText>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="mud-text-secondary">
                    Enter your details below to get started
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent Class="pa-6 pt-0">
            <EditForm Model="@model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <MudGrid Spacing="2">
                    <MudItem xs="6">
                        <MudTextField Label="First Name" Variant="Variant.Outlined"
                                      @bind-Value="model.FirstName" For="@(() => model.FirstName)" Required="true" />
                    </MudItem>

                    <MudItem xs="6">
                        <MudTextField Label="Last Name" Variant="Variant.Outlined"
                                      @bind-Value="model.LastName" For="@(() => model.LastName)" Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Username"
                                      Placeholder="Username"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Text"
                                      @bind-Value="model.Username"
                                      For="@(() => model.Username)"
                                      Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Password" Variant="Variant.Outlined" InputType="InputType.Password"
                                      @bind-Value="model.Password" For="@(() => model.Password)" Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="Confirm Password" Variant="Variant.Outlined" InputType="InputType.Password"
                                      @bind-Value="model.ConfirmPassword" For="@(() => model.ConfirmPassword)" Required="true" />
                    </MudItem>

                    <MudItem xs="12" Class="mt-4">
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                                   FullWidth="true" Size="Size.Large" Disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Creating...</MudText>
                            }
                            else
                            {
                                <MudText>Create Account</MudText>
                            }
                        </MudButton>
                    </MudItem>

                </MudGrid>
            </EditForm>
        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pa-6 pt-2">
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                Already have an account?
                <MudLink Href="/login" Typo="Typo.body2">Sign In</MudLink>
            </MudText>
        </MudCardActions>

    </MudCard>
</MudContainer>

@code {
    public RegisterDTO model { get; set; } = new();

    private bool _isLoading = false;

    protected override void OnInitialized()
    {
        model ??= new();
    }

    public class RegisterDTO
    {
        [Required(ErrorMessage = "First name is required")]
        public string FirstName { get; set; }

        [Required(ErrorMessage = "Last name is required")]
        public string LastName { get; set; }

        [Required(ErrorMessage = "Username is required")]
        [RegularExpression(@"^[a-zA-Z0-9_]+$", ErrorMessage = "Username can only contain letters, numbers, and underscores.")]
        public string Username { get; set; }

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; }

        [Required(ErrorMessage = "Please confirm your password")]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; }
    }

    private async Task HandleValidSubmit()
    {
        _isLoading = true;

        try
        {
            var signupRequest = new SignupRequest
            {
                Name = model.FirstName,
                LastName = model.LastName,
                UserName = model.Username,
                Password = model.Password
            };

            // ApiClient.PostAsync throws if the request fails.
            await apiClient.PostAsync("api/Auth/Register", signupRequest);

            Snackbar.Add("Account created successfully!", Severity.Success);
            NavigationManager.NavigateTo("/home");
        }
        catch (HttpRequestException ex)
        {
            // extract backend message
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"System Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

}