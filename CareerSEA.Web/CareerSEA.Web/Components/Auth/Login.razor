@page "/"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using System.Text.Json.Serialization
@using MudBlazor

@inject TokenStore tokenStore
@inject ServerApiClient apiClient
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Log In</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="d-flex align-center justify-center" Style="min-height: 100vh; padding: 0.5rem;">

    <MudCard Elevation="20" Class="w-100" Style="max-width: 28rem;">

        <MudCardHeader Class="pa-6">
            <CardHeaderContent>
                <MudText Typo="Typo.h5" Align="Align.Center" Class="font-weight-bold">Welcome Back</MudText>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="mud-text-secondary">
                    Enter your credentials to access your account
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent Class="pa-6 pt-0">
            <EditForm Model="@model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <MudGrid Spacing="2">

                    <MudItem xs="12">
                        @* Removed Placeholder attribute here *@
                        <MudTextField Label="Username"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Text"
                                      @bind-Value="model.Username"
                                      For="@(() => model.Username)"
                                      Required="true"
                                      Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12">
                        @* Removed Placeholder attribute here *@
                        <MudTextField Label="Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      @bind-Value="model.Password"
                                      For="@(() => model.Password)"
                                      Required="true"
                                      Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12" Class="mt-4">
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                                   FullWidth="true" Size="Size.Large" Disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Signing In...</MudText>
                            }
                            else
                            {
                                <MudText>Sign In</MudText>
                            }
                        </MudButton>
                    </MudItem>

                </MudGrid>
            </EditForm>
        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pa-6 pt-2">
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                Don't have an account?
                <MudLink Href="/signup" Typo="Typo.body2">Sign Up</MudLink>
            </MudText>
        </MudCardActions>

    </MudCard>
</MudContainer>

@code {
    public LoginModel model { get; set; } = new();

    private bool _isLoading = false;

    protected override void OnInitialized()
    {
        model ??= new();
    }

    private async Task HandleValidSubmit()
    {
        _isLoading = true;

        try
        {
            var loginRequest = new LoginApiRequest
            {
                UserName = model.Username,
                Password = model.Password
            };

            var response = await apiClient.PostAsync<LoginApiRequest, LoginApiResponse>("api/Auth/Login", loginRequest);

            if (response != null && response.Status)
            {
                await tokenStore.SetAccessTokenAsync(response.Data.AccessToken);
                await tokenStore.SetRefreshTokenAsync(response.Data.RefreshToken);
                Snackbar.Add("Login Successful!", Severity.Success);
                NavigationManager.NavigateTo("/experience");
            }
            else
            {
                Snackbar.Add(response?.Message ?? "Invalid credentials", Severity.Error);
            }
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"System Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; }

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; }
    }

    public class LoginApiRequest
    {
        [JsonPropertyName("userName")]
        public string UserName { get; set; }

        [JsonPropertyName("password")]
        public string Password { get; set; }
    }

    public class LoginApiResponse
    {
        public bool Status { get; set; }
        public string Message { get; set; }
        public LoginTokenData Data { get; set; }
    }

    public class LoginTokenData
    {
        public string AccessToken { get; set; }
        public string RefreshToken { get; set; }
    }
}